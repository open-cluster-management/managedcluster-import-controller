ARG DOCKER_BASE_IMAGE

FROM $DOCKER_BASE_IMAGE

ARG REMOTE_SOURCE
ARG REMOTE_SOURCE_DIR
ARG GITHUB_TOKEN

ENV OPERATOR=/usr/local/bin/rcm-controller \
    USER_UID=1001 \
    USER_NAME=rcm-controller \
    KLUSTERLET_CRD_FILE=/usr/local/resources/agent.open-cluster-management.io_v1beta1_klusterlet_crd.yaml

USER root
# Install unzip
RUN microdnf -y install unzip
RUN microdnf -y install procps
RUN microdnf update

# install operator binary
RUN cp ${OPERATOR}-coverage ${OPERATOR}
# install aws cli
RUN	curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.0.30.zip" -o "awscliv2.zip";
RUN	unzip awscliv2.zip;
RUN	./aws/install;
RUN rm awscliv2.zip
RUN rm -rf aws

# install kubectl
RUN curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
RUN chmod +x ./kubectl
RUN mv ./kubectl /usr/local/bin/kubectl

USER ${USER_UID}

ENTRYPOINT ["/usr/local/bin/entrypoint-coverage"]

ARG VCS_REF
ARG VCS_URL
ARG IMAGE_NAME
ARG IMAGE_DESCRIPTION
ARG ARCH_TYPE
ARG REMOTE_SOURCE_DIR

LABEL com.redhat.component="rcm-controller-container" \
      name="rhacm1-tech-preview/rcm-controller-rhel8" \
      version="${CI_CONTAINER_VERSION}" \
      release="${CI_CONTAINER_RELEASE}" \
      summary="rcm-controller" \
      io.openshift.expose-services="" \
      io.openshift.tags="data,images" \
      io.k8s.display-name="rcm-controller" \
      maintainer="['eisraeli@redhat.com', 'jbieren@redhat.com']" \
      description="rcm-controller"