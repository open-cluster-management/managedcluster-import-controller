# Manual importing of an existing cluster

## Prerequisite

### Creating a ClusterRegistry Cluster

- Edit the example of ClusterRegistry cluster [/test/resources/test_cluster.yaml](https://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_cluster.yaml)
- Refer to <https://github.com/kubernetes/cluster-registry/blob/master/pkg/apis/clusterregistry/v1alpha1/types.go> for API definition
- Create a ClusterRegistry cluster: `oc apply -f test_cluster.yaml`

### Creating a MultiCloud EndpointConfig for the cluster you are importing

- Edit the example of EndpointConfig resource refer to [/test/resources/test_endpoint_config.yaml](https://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_endpoint_config.yaml)
- Refer to [/pkg/apis/multicloud/v1alpha1/endpointconfig_types.go](https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/apis/multicloud/v1alpha1/endpointconfig_types.go) and [endpoint-operator - /pkg/apis/multicloud/v1beta1/endpoint_types.go](https://github.com/open-cluster-management/endpoint-operator/blob/master/pkg/apis/multicloud/v1beta1/endpoint_types.go) for API definition
- Create a Multicloud EndpointConfig: `oc apply -f test_endpoint_config.yaml`

## ClusterController actions

### EndpointConfig Controller

- EndpointConfig creation triggers `Reconcile()` in [/pkg/controllers/endpointconfig/endpointconfig_controller.go](https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/controller/endpointconfig/endpointconfig_controller.go).
- Controller will use information in EndpointConfig to generate a secret named `{cluster-name}-import`.
- The `{cluster-name}-import` secret contains the import.yaml that the user will apply on managed cluster to install multicluster-endpoint.

## Obtaining the import.yaml generated by the cluster controller

- MacOS X

```bash
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -D > import.yaml
```

- Linux

```bash
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -d > import.yaml
```

## Installing multicluster-endpoint on managed cluster

- Authenticate to your managed cluster
- Apply the `import.yaml` generated in previous step with `kubectl apply -f import.yaml`
