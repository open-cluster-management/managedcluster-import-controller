# Manual importing of an existing cluster

## Prerequisite

### Creating a ClusterRegistry Cluster

On the Hub Cluster: 
- Create namespace: `oc create ns cluster-controller-test`
- oc create -n cluster-controller-test secret docker-registry quay-secret --docker-server=quay.io --docker-username=${DOCKER_USER} --docker-password=${DOCKER_PASS}

- Edit the example of ClusterRegistry cluster [/test/resources/test_cluster.yaml](https://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_cluster.yaml)
- Add imagePullSecret: quay-secret in test_endpoint_config.yaml
- Create a ClusterRegistry cluster: `oc apply -f test_cluster.yaml`
- Refer to <https://github.com/kubernetes/cluster-registry/blob/master/pkg/apis/clusterregistry/v1alpha1/types.go> for API definition

### Creating a MultiCloud KlusterletConfig for the cluster you are importing

- Edit the example of KlusterletConfig resource refer to [/test/resources/test_klusterlet_config.yaml](https://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_klusterlet_config.yaml)
- Refer to [/pkg/apis/agent/v1beta1/klusterletconfig_types.go](https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/apis/agent/v1beta1/klusterletconfig_types.go) and [klusterlet-operator - /pkg/apis/multicloud/v1beta1/endpoint_types.go](https://github.com/open-cluster-management/endpoint-operator/blob/master/pkg/apis/multicloud/v1beta1/endpoint_types.go) for API definition
- Create a Multicloud KlusterletConfig: `oc apply -f test_klusterlet_config.yaml`

## ClusterController actions

### KlusterletConfig Controller

- KlusterletConfig creation triggers `Reconcile()` in [/pkg/controllers/klusterletconfig/klusterletconfig_controller.go](https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/controller/klusterletconfig/klusterletconfig_controller.go).
- Controller will use information in KlusterletConfig to generate a secret named `{cluster-name}-import`.
- The `{cluster-name}-import` secret contains the import.yaml that the user will apply on managed cluster to install klusterlet.

## Obtaining the import.yaml generated by the cluster controller

- MacOS X

```bash
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -D > import.yaml
```

- Linux

```bash
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -d > import.yaml
```



## Installing klusterlet on managed cluster

- Login to your target cluster:
- Apply the `import.yaml` generated in previous step with `kubectl apply -f import.yaml` --validate=false


Validation:
- check the pod status on the target cluster: `kubectl get pod -n klusterlet`
- check the cluster cluster on the hub: `kubectl get cluster --all-namespaces`
